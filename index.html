<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GeoBible Viewer</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    select { margin-bottom: 20px; padding: 5px; font-size: 1em; width: 100%; max-width: 400px; }
    h2 { font-size: 1.5em; }
    p { line-height: 1.6; }
    sup {
      font-size: 0.7em;
      vertical-align: super;
      color: #666;
      font-weight: bold;
      margin-right: 3px;
    }
    button.loc-button {
      font-size: 0.8em;
      margin-left: 5px;
      padding: 1px 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>GeoBible Viewer</h2>

  <label for="testament">Select Testament:</label>
  <select id="testament">
    <option value="old">Old Testament</option>
    <option value="new">New Testament</option>
  </select>

  <label for="passage">Select a passage:</label>
  <select id="passage"></select>

  <div id="bible">Loading...</div>

  <script>
    const oldTestament = ["Genesis", "Exodus", "Leviticus", "Numbers", "Deuteronomy", "Joshua", "Judges", "Ruth", "1 Samuel", "2 Samuel", "1 Kings", "2 Kings", "1 Chronicles", "2 Chronicles", "Ezra", "Nehemiah", "Esther", "Job", "Psalms", "Proverbs", "Ecclesiastes", "Song of Solomon", "Isaiah", "Jeremiah", "Lamentations", "Ezekiel", "Daniel", "Hosea", "Joel", "Amos", "Obadiah", "Jonah", "Micah", "Nahum", "Habakkuk", "Zephaniah", "Haggai", "Zechariah", "Malachi"];

    const newTestament = ["Matthew", "Mark", "Luke", "John", "Acts", "Romans", "1 Corinthians", "2 Corinthians", "Galatians", "Ephesians", "Philippians", "Colossians", "1 Thessalonians", "2 Thessalonians", "1 Timothy", "2 Timothy", "Titus", "Philemon", "Hebrews", "James", "1 Peter", "2 Peter", "1 John", "2 John", "3 John", "Jude", "Revelation"];

    const geoLocations = {
      "Matthew 2:1": { name: "Bethlehem", lat: 31.7054, lon: 35.2024 },
      "Matthew 3:1": { name: "Judean Wilderness", lat: 31.7500, lon: 35.2500 },
      "Matthew 4:13": { name: "Capernaum", lat: 32.8869, lon: 35.5723 },
      "Matthew 4:18": { name: "Sea of Galilee", lat: 32.833, lon: 35.588 },
      "Matthew 5:1": { name: "Mount of Beatitudes", lat: 32.8803, lon: 35.5559 },
      "Matthew 8:28": { name: "Gadara", lat: 32.6716, lon: 35.6621 },
      "Matthew 16:13": { name: "Caesarea Philippi", lat: 33.2451, lon: 35.6939 },
      "Matthew 20:29": { name: "Jericho", lat: 31.8667, lon: 35.4500 },
      "Matthew 21:1": { name: "Mount of Olives", lat: 31.7784, lon: 35.2436 },
      "Matthew 27:33": { name: "Golgotha", lat: 31.7784, lon: 35.2296 }
    };

    const testamentSelect = document.getElementById("testament");
    const passageSelect = document.getElementById("passage");
    const bibleDiv = document.getElementById("bible");

    function populatePassages(testamentBooks) {
      passageSelect.innerHTML = "";
      testamentBooks.forEach(book => {
        for (let i = 1; i <= 50; i++) {
          const option = document.createElement("option");
          option.value = `${book} ${i}`;
          option.text = `${book} ${i}`;
          passageSelect.appendChild(option);
        }
      });
    }

    function loadPassage(passage) {
      bibleDiv.innerHTML = "Loading...";
      fetch(`https://labs.bible.org/api/?passage=${encodeURIComponent(passage)}&type=json`)
        .then(res => res.json())
        .then(data => {
          if (data.length === 0) {
            bibleDiv.innerHTML = "No text found.";
            return;
          }

          const book = data[0].bookname;
          const chapter = data[0].chapter;

          let html = `<h3>${book} ${chapter}</h3><p>`;
          html += data.map(v => {
            const ref = `${v.bookname} ${v.chapter}:${v.verse}`;
            const loc = geoLocations[ref];
            const button = loc ? `<button class='loc-button' onclick="focusMap(${loc.lat}, ${loc.lon})">${loc.name}</button>` : "";
            return `<sup>${v.verse}</sup> ${v.text.trim()} ${button}`;
          }).join(' ');
          html += `</p>`;

          bibleDiv.innerHTML = html;
        })
        .catch(err => {
          bibleDiv.innerText = "Failed to load passage.";
          console.error(err);
        });
    }

    function focusMap(lat, lon) {
      window.parent.postMessage({ type: "map-center", lat, lon }, "*");
    }

    // Initial setup
    populatePassages(oldTestament);
    loadPassage(passageSelect.value);

    testamentSelect.addEventListener("change", () => {
      const testament = testamentSelect.value === "old" ? oldTestament : newTestament;
      populatePassages(testament);
      loadPassage(passageSelect.value);
    });

    passageSelect.addEventListener("change", () => {
      loadPassage(passageSelect.value);
      window.parent.postMessage({ type: "passage", value: passageSelect.value }, "*");
    });
  </script>
</body>
</html>
